<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Birdbox</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Birdbox</h1>
    <div id="app">
      <div id="videos" v-for="video in videos" :key="video.name">
        <article>
          <header><strong>{{ video.name }}</strong></header>
          <div v-if="!video.isPlaying" @click="play(video)">
            <div class="thumbnail-wrapper">
              <img :src="`/thumbnails/${video.filename}.png`" />
              <div class="control-icon">
                <svg height="32px" viewBox="0 0 512 512" width="32px">
                  <path
                    d="M405.2,232.9L126.8,67.2c-3.4-2-6.9-3.2-10.9-3.2c-10.9,0-19.8,9-19.8,20H96v344h0.1c0,11,8.9,20,19.8,20  c4.1,0,7.5-1.4,11.2-3.4l278.1-165.5c6.6-5.5,10.8-13.8,10.8-23.1C416,246.7,411.8,238.5,405.2,232.9z" />
                </svg>
              </div>
            </div>
          </div>
          <div v-if="video.isPlaying" @click="stop(video)">
            <div class="thumbnail-wrapper">
              <img :src="`/thumbnails/${video.filename}.png`" />
              <div class="control-icon">
                <svg height="32px" viewBox="0 0 512 512" width="32px">
                  <path
                    d="M392,432H120a40,40,0,0,1-40-40V120a40,40,0,0,1,40-40H392a40,40,0,0,1,40,40V392A40,40,0,0,1,392,432Z" />
                </svg>
              </div>
            </div>
          </div>
          <footer>
            <div class="row">
              <div v-if="!video.isPlaying">
                <small>Duration {{ video.duration }}</small>
              </div>
              <div v-if="video.isPlaying">
                <small>Playing {{ video.time }}</small>
              </div>
              <div v-if="video.isPlaying">
                <button>View Live Stream</button>
              </div>
            </div>
          </footer>
        </article>
      </div>
    </div>
    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            videos: [],
          };
        },
        methods: {
          play(video) {
            // find currently playing video, if any, and reset it
            const currentlyPlaying = this.videos.find((v) => v.isPlaying);
            if (currentlyPlaying) {
              this.resetVideo(currentlyPlaying);
            }

            playVideo(video);

            video.isPlaying = true;
            video.time = "00:00:00";
            video.seconds = 0;
            video.interval = setInterval(() => {
              video.seconds += 1;
              video.time = formatSeconds(video.seconds);
            }, 1000);
          },
          stop(video) {
            stopVideo(video);
            this.resetVideo(video);
          },
          resetVideo(video) {
            XMLDocument;
            video.isPlaying = false;
            video.time = "00:00:00";
            video.seconds = 0;
            clearInterval(video.interval ?? 0);
          },
        },
        async mounted() {
          const res = await fetch("/api/videos");
          this.videos = await res.json();
          console.log(this.videos);
        },
      }).mount("#app");

      const playVideo = async (video) => {
        // post to server to relay ws command
        console.log("start", video);
        await fetch("/api/command", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            type: "command",
            action: "start",
            video: video.filename,
          }),
        });
      };

      const stopVideo = async (video) => {
        console.log("stop", video);
        await fetch("/api/command", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            type: "command",
            action: "stop",
            video: video.filename,
          }),
        });
      };

      const formatSeconds = (seconds) => {
        const hrs = Math.floor(seconds / 3600)
          .toString()
          .padStart(2, "0");
        const mins = Math.floor((seconds % 3600) / 60)
          .toString()
          .padStart(2, "0");
        const secs = Math.floor(seconds % 60)
          .toString()
          .padStart(2, "0");
        return `${hrs}:${mins}:${secs}`;
      };
    </script>
  </body>
</html>
