<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Birdbox</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Birdbox</h1>
    <div id="app">
      <div id="videos" v-for="video in videos" :key="video.name">
        <article>
          <header><strong>{{ video.name }}</strong></header>
          <div v-if="!video.isPlaying" @click="start(video)">
            <div class="thumbnail-wrapper">
              <img :src="`/thumbnails/${video.id}.png`" />
              <div class="control-icon">
                <svg height="32px" viewBox="0 0 512 512" width="32px">
                  <path
                    d="M405.2,232.9L126.8,67.2c-3.4-2-6.9-3.2-10.9-3.2c-10.9,0-19.8,9-19.8,20H96v344h0.1c0,11,8.9,20,19.8,20  c4.1,0,7.5-1.4,11.2-3.4l278.1-165.5c6.6-5.5,10.8-13.8,10.8-23.1C416,246.7,411.8,238.5,405.2,232.9z" />
                </svg>
              </div>
            </div>
          </div>
          <div v-if="video.isPlaying" @click="stop(video)">
            <div class="thumbnail-wrapper">
              <img :src="`/thumbnails/${video.id}.png`" />
              <div class="control-icon">
                <svg height="32px" viewBox="0 0 512 512" width="32px">
                  <path
                    d="M392,432H120a40,40,0,0,1-40-40V120a40,40,0,0,1,40-40H392a40,40,0,0,1,40,40V392A40,40,0,0,1,392,432Z" />
                </svg>
              </div>
            </div>
          </div>
          <footer>
            <div class="row">
              <div v-if="!video.isPlaying">
                <small>Duration {{ video.duration }}</small>
              </div>
              <!--fix this only one v-if-->
              <div v-if="video.isPlaying">
                <small>Playing</small>
              </div>
              <div v-if="video.isPlaying">
                <button>View Live Stream</button>
              </div>
            </div>
          </footer>
        </article>
      </div>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
      // TODO set up ws ping/pong to detect connection lost to
      //      server. When lost, display overlay "Connection lost
      //      to server [Refresh] to reconnect"

      const { createApp } = Vue;

      createApp({
        data() {
          return {
            videos: [],
            ws: undefined,
            clientId: undefined,
          };
        },
        methods: {
          connect() {
            // connect to server
            this.clientId = crypto.randomUUID();
            this.ws.onopen = () => {
              // register as browser
              this.ws.send(
                JSON.stringify({
                  type: "connection",
                  clientType: "browser",
                  clientId: this.clientId,
                })
              );

              // receive messages from server
              this.ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                this.videos.find((v) => v.id === msg.id).isPlaying =
                  msg.action === "start";
              };
            };
          },
          start(video) {
            // stop if a video is currently playing
            const currentlyPlaying = this.videos.find((v) => v.isPlaying);
            if (currentlyPlaying) {
              this.stop(currentlyPlaying);
            }

            this.sendMessage({
              id: video.id,
              type: "command",
              action: "start",
            });

            video.isPlaying = true;
          },
          stop(video) {
            this.sendMessage({
              id: video.id,
              type: "command",
              action: "stop",
            });

            video.isPlaying = false;
          },
          sendMessage(msg) {
            this.ws.send(
              JSON.stringify({
                ...msg,
                clientType: "browser",
                clientId: this.clientId,
              })
            );
          },
        },
        async mounted() {
          // get ws config from server
          // TODO refactor both calls as await

          const resConfig = await fetch("/api/config");
          const config = await resConfig.json();

          this.ws = new WebSocket(config.SERVER_ADDRESS);
          this.connect();

          const resVideos = await fetch("/api/videos");
          this.videos = await resVideos.json();

          // fetch("/api/config")
          //   .then((res) => res.json())
          //   .then(async (config) => {
          //     this.ws = new WebSocket(config.SERVER_ADDRESS);
          //     this.connect();

          //     // get list of videos
          //     const res = await fetch("/api/videos");
          //     this.videos = await res.json();
          //   });
        },
      }).mount("#app");
    </script>
  </body>
</html>
