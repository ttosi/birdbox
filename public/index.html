<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Birdbox</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h1>Birdbox</h1>
    <div id="app">
      <div id="videos" v-for="video in videos" :key="video.name">
        <article>
          <header><strong>{{ video.name }}</strong></header>
          <div v-if="!video.isPlaying" @click="start(video)">
            <div class="thumbnail-wrapper">
              <img :src="`/thumbnails/${video.id}.png`" />
              <div class="control-icon">
                <svg height="32px" viewBox="0 0 512 512" width="32px">
                  <path
                    d="M405.2,232.9L126.8,67.2c-3.4-2-6.9-3.2-10.9-3.2c-10.9,0-19.8,9-19.8,20H96v344h0.1c0,11,8.9,20,19.8,20  c4.1,0,7.5-1.4,11.2-3.4l278.1-165.5c6.6-5.5,10.8-13.8,10.8-23.1C416,246.7,411.8,238.5,405.2,232.9z" />
                </svg>
              </div>
            </div>
          </div>
          <div v-if="video.isPlaying" @click="stop(video)">
            <div class="thumbnail-wrapper">
              <img :src="`/thumbnails/${video.id}.png`" />
              <div class="control-icon">
                <svg height="32px" viewBox="0 0 512 512" width="32px">
                  <path
                    d="M392,432H120a40,40,0,0,1-40-40V120a40,40,0,0,1,40-40H392a40,40,0,0,1,40,40V392A40,40,0,0,1,392,432Z" />
                </svg>
              </div>
            </div>
          </div>
          <footer>
            <div class="row">
              <div v-if="!video.isPlaying">
                <small>Duration {{ video.duration }}</small>
              </div>
              <!--fix this only one v-if-->
              <div v-if="video.isPlaying">
                <small>Playing</small>
              </div>
              <div v-if="video.isPlaying">
                <button>View Live Stream</button>
              </div>
            </div>
          </footer>
        </article>
      </div>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            videos: [],
            ws: undefined,
            clientId: undefined,
          };
        },
        methods: {
          connect() {
            // open connection to ws server and
            this.clientId = crypto.randomUUID();
            this.ws.onopen = () => {
              // register as a browser
              this.ws.send(
                JSON.stringify({
                  type: "connection",
                  clientType: "browser",
                  clientId: this.clientId,
                })
              );

              // receive ws messages from server
              this.ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log(msg);
                this.videos.find((v) => v.id === msg.id).isPlaying =
                  msg.action === "start";
              };
            };
          },
          start(video) {
            // if video playing
            const playing = this.videos.find((v) => v.isPlaying);
            if (playing) {
              this.stop(playing); // send ws stop message
            }

            // playVideo(video); // change to ws call

            this.sendMessage({
              id: video.id,
              type: "command",
              action: "start",
            });

            video.isPlaying = true;
          },
          stop(video) {
            // stopVideo(video); // change to ws call (sendMessage(video))

            // send stop command to server so it can
            // update all the client's video state
            this.sendMessage({
              id: video.id,
              type: "command",
              action: "stop",
            });

            video.isPlaying = false;
          },
          sendMessage(msg) {
            this.ws.send(
              JSON.stringify({
                ...msg,
                clientType: "browser",
                clientId: this.clientId,
              })
            );
          },
        },
        async mounted() {
          // get ws config from server (REST)
          // TODO refactor both calls as await
          fetch("/api/config")
            .then((res) => res.json())
            .then(async (config) => {
              this.ws = new WebSocket(config.SERVER_ADDRESS);
              this.connect();

              // get list of videos
              const res = await fetch("/api/videos");
              this.videos = await res.json();
            });
        },
      }).mount("#app");

      // move to vue object, change to ws
      const playVideo = async (msg) => {
        await fetch("/api/command", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            id: msg.id,
            type: "command",
            action: "start",
          }),
        });
      };

      // move to vue object, change to ws
      const stopVideo = async (msg) => {
        console.log("stop", msg);
        await fetch("/api/command", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            id: msg.id,
            type: "command",
            action: "stop",
          }),
        });
      };

      const post = () => {};

      const formatSeconds = (seconds) => {
        const hrs = Math.floor(seconds / 3600)
          .toString()
          .padStart(2, "0");
        const mins = Math.floor((seconds % 3600) / 60)
          .toString()
          .padStart(2, "0");
        const secs = Math.floor(seconds % 60)
          .toString()
          .padStart(2, "0");
        return `${hrs}:${mins}:${secs}`;
      };
    </script>
  </body>
</html>
