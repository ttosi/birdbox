<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Birdbox</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <dialog id="socketDisconnected">
      <article>
        <header style="text-align: center">
          <p>
            <strong>ðŸ˜¾ Connection Lost ðŸ˜¿</strong>
          </p>
        </header>
        <p>
          The connection to the birdbox server was lost. Please, refresh the
          page to attempt to reconnect.
        </p>
      </article>
    </dialog>
    <h1>Birdbox</h1>
    <div id="app">
      <!-- not authenticated -->
      <div v-if="!isAuthenticated">
        <input v-model="apiKey" type="text" placeholder="ENTER API KEY" />
        <input type="button" value="Submit" @click="authenticate" />
      </div>
      <!-- videos list -->
      <div v-if="!viewingStream">
        <div id="videos" v-for="video in videos" :key="video.name">
          <article
            :style="{ border: video.isPlaying ? '2px solid lightgreen': 'none'}"
            style="">
            <header><strong>{{ video.name }}</strong></header>
            <div v-if="!video.isPlaying" @click="start(video)">
              <div class="thumbnail-wrapper">
                <img :src="`/thumbnails/${video.id}.png`" />
                <div class="control-icon">
                  <svg height="32px" viewBox="0 0 512 512" width="32px">
                    <path
                      d="M405.2,232.9L126.8,67.2c-3.4-2-6.9-3.2-10.9-3.2c-10.9,0-19.8,9-19.8,20H96v344h0.1c0,11,8.9,20,19.8,20  c4.1,0,7.5-1.4,11.2-3.4l278.1-165.5c6.6-5.5,10.8-13.8,10.8-23.1C416,246.7,411.8,238.5,405.2,232.9z" />
                  </svg>
                </div>
              </div>
            </div>
            <div v-if="video.isPlaying" @click="stop(video)">
              <div class="thumbnail-wrapper">
                <img :src="`/thumbnails/${video.id}.png`" />
                <div class="control-icon">
                  <svg height="32px" viewBox="0 0 512 512" width="32px">
                    <path
                      d="M392,432H120a40,40,0,0,1-40-40V120a40,40,0,0,1,40-40H392a40,40,0,0,1,40,40V392A40,40,0,0,1,392,432Z" />
                  </svg>
                </div>
              </div>
            </div>
            <footer>
              <div>
                <div v-if="!video.isPlaying">
                  <small>Duration {{ video.duration }}</small>
                </div>
                <div v-else class="row">
                  <div>Playing</div>
                  <div>
                    <button @click="viewStream">View Live Stream</button>
                  </div>
                </div>
              </div>
            </footer>
          </article>
        </div>
      </div>
      <div v-else>streaming</div>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            config: undefined,
            videos: [],
            ws: undefined,
            clientId: undefined,
            apiKey: undefined,
            isAuthenticated: false,
            viewingStream: false,
          };
        },
        methods: {
          connect() {
            // connect to server
            this.ws = new WebSocket(this.config.SERVER_ADDRESS);
            this.clientId = crypto.randomUUID();

            this.ws.onopen = () => {
              // register as browser
              this.ws.send(
                JSON.stringify({
                  type: "connection",
                  clientType: "browser",
                  clientId: this.clientId,
                })
              );
            };

            // receive messages from server
            this.ws.onmessage = (event) => {
              const msg = JSON.parse(event.data);
              this.videos.find((v) => v.id === msg.id).isPlaying =
                msg.action === "start";
            };

            this.ws.onclose = (ev) => {
              const dialog = document.getElementById("socketDisconnected");
              dialog.setAttribute("open", "");
            };
          },
          start(video) {
            // stop if a video is currently playing
            const currentlyPlaying = this.videos.find((v) => v.isPlaying);
            if (currentlyPlaying) {
              this.stop(currentlyPlaying);
            }

            this.sendMessage({
              id: video.id,
              type: "command",
              action: "start",
            });

            video.isPlaying = true;
          },
          stop(video) {
            this.sendMessage({
              id: video.id,
              type: "command",
              action: "stop",
            });

            video.isPlaying = false;
          },
          viewStream() {
            this.viewingStream = true;
          },
          sendMessage(msg) {
            this.ws.send(
              JSON.stringify({
                ...msg,
                clientType: "browser",
                clientId: this.clientId,
              })
            );
          },
          async authenticate() {
            const res = await fetch("/api/auth", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ apiKey: this.apiKey }),
            });

            const authenticated = await res.json();

            // api key is valid
            if (authenticated) {
              this.load();
              this.isAuthenticated = true;
              return;
            }

            this.apiKey = "";
          },
          async load() {
            const res = await fetch("/api/config");
            this.config = await res.json();

            this.connect();

            const resVideos = await fetch("/api/videos");
            this.videos = await resVideos.json();
          },
        },
        async mounted() {
          if (Cookies.get("apiKey")) {
            this.load();
            this.isAuthenticated = true;
          }
        },
      }).mount("#app");
    </script>
  </body>
</html>
